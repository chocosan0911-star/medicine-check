<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãŠè–¬ãƒã‚§ãƒƒã‚¯</title>

  <link rel="manifest" href="manifest.json">

  <style>
    body { font-family: sans-serif; text-align:center; padding:30px; }
    h1 { font-size:28px; }
    #timeMessage { font-size:20px; margin:20px; padding:15px; border-radius:10px; }
    .normal { background:#e0e0e0; }
    .time-alert { background:#4caf50; color:white; font-weight:bold; }
    .missed { background:#f44336; color:white; font-weight:bold; }
    button { font-size:20px; padding:15px 30px; border-radius:10px; border:none; background:#2196f3; color:white; }
    #lastTime { font-size:18px; margin-top:20px; }
  </style>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("OjzEQ0J-l-_Qwh3ci"); // â†è‡ªåˆ†ã®Public Key
  </script>

</head>

<body>
<h1>ğŸ’Š ãŠè–¬ãƒã‚§ãƒƒã‚¯</h1>

<div id="timeMessage" class="normal"></div>

<button id="takeBtn">é£²ã‚“ã </button>

<p id="lastTime">ã¾ã é£²ã‚“ã§ã„ã¾ã›ã‚“</p>

<script>

const MORNING = 7;
const EVENING = 18;

const message = document.getElementById("timeMessage");
const lastTime = document.getElementById("lastTime");
const btn = document.getElementById("takeBtn");

let lastTaken = localStorage.getItem("lastTaken");

// é£²ã¿å¿˜ã‚Œãƒ¡ãƒ¼ãƒ«é€ä¿¡é–¢æ•°ï¼ˆ1å›ã ã‘ï¼‰
function sendMissedMail(type) {
  const sent = localStorage.getItem("missMailSent");
  if (sent === type) return; // ã™ã§ã«é€ä¿¡æ¸ˆã¿

  emailjs.send(
    "YOUR_SERVICE_ID",
    "YOUR_TEMPLATE_ID",
    {
      message: `âš  ${type}ã®ãŠè–¬ã‚’é£²ã¿å¿˜ã‚Œã¦ã„ã¾ã™`,
      time: new Date().toLocaleString()
    }
  );

  localStorage.setItem("missMailSent", type);
}

// UIæ›´æ–°
function updateUI() {
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();

  message.className = "normal";
  message.textContent = "æ¬¡ã®ãŠè–¬æ™‚é–“ã‚’å¾…ã£ã¦ã„ã¾ã™";

  // 7:00 / 18:00 ãƒ”ãƒƒã‚¿ãƒª
  if ((hour === MORNING || hour === EVENING) && minute === 0) {
    message.className = "time-alert";
    message.textContent = "â° ãŠè–¬ã‚’é£²ã‚“ã§ãã ã•ã„ï¼";
  }

  // é£²ã¿å¿˜ã‚Œåˆ¤å®š
  if (lastTaken) {
    const last = new Date(lastTaken);

    // æœã®é£²ã¿å¿˜ã‚Œï¼ˆ8æ™‚ä»¥é™ï¼‰
    if (hour >= 8 && last.getHours() < MORNING) {
      message.className = "missed";
      message.textContent = "âš  æœã®ãŠè–¬ã‚’é£²ã¿å¿˜ã‚Œã¦ã„ã¾ã™";
      sendMissedMail("æœ");
    }

    // å¤œã®é£²ã¿å¿˜ã‚Œï¼ˆ19æ™‚ä»¥é™ï¼‰
    if (hour >= 19 && last.getHours() < EVENING) {
      message.className = "missed";
      message.textContent = "âš  å¤œã®ãŠè–¬ã‚’é£²ã¿å¿˜ã‚Œã¦ã„ã¾ã™";
      sendMissedMail("å¤œ");
    }
  }
}

// é£²ã‚“ã ãƒœã‚¿ãƒ³
btn.addEventListener("click", () => {
  const now = new Date();
  localStorage.setItem("lastTaken", now);
  localStorage.removeItem("missMailSent"); // â†ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ¡ãƒ¼ãƒ«å†é€å¯èƒ½ã«

  lastTaken = now;
  lastTime.textContent = "ğŸ•’ æœ€å¾Œã«é£²ã‚“ã æ™‚é–“ï¼š" + now.toLocaleTimeString();

  // EmailJSã§é€šå¸¸å ±å‘Šãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰
  emailjs.send(
    "service_zmsn0wy",
    "template_tt2bsvq",
    { message: "âœ… è–¬ã‚’é£²ã¿ã¾ã—ãŸ", time: now.toLocaleString() }
  );
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¡¨ç¤º
if (lastTaken) {
  lastTime.textContent =
    "ğŸ•’ æœ€å¾Œã«é£²ã‚“ã æ™‚é–“ï¼š" + new Date(lastTaken).toLocaleTimeString();
}

updateUI();
setInterval(updateUI, 60000); // 1åˆ†ã”ã¨æ›´æ–°
</script>
</body>
</html>
